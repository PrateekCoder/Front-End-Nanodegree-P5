function initialize(){ko.applyBindings(new ViewModel)}var ViewModel=function(){function e(){return Math.floor(1e12*Math.random()).toString()}var n=this;n.query=ko.observable(""),n.locations=ko.observableArray([]),n.filteredLocations=ko.observableArray([]),n.map=null,n.latlong=null,n.openWindow=null,n.infowindow=null;var o;n.initMap=function(){n.latlong=new google.maps.LatLng(37.8717,-122.2728);var e={center:n.latlong,zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP};n.map=new google.maps.Map(document.getElementById("map"),e),o=new google.maps.places.PlacesService(n.map),n.initMarkers()},n.initMarkers=function(){var e={location:n.latlong,radius:"1000",types:["gym"]};o.nearbySearch(e,n.searchCallback)},n.searchCallback=function(e,o){var t,a;if(o===google.maps.places.PlacesServiceStatus.OK)for(var i=0;i<e.length;i++)a=new Location(e[i]),t=n.getMarker(a),a.marker=t,n.locations.push(a),n.filteredLocations.push(a)},n.getPhone=function(e,t,a){o.getDetails(e,function(e,o){o===google.maps.places.PlacesServiceStatus.OK&&(t.phone=e.formatted_phone_number),n.getYelpReviews(t,a)})},n.createWindow=function(e,o){n.infowindow=new google.maps.InfoWindow({content:e.content,maxWidth:300}),e.infowindow=n.infowindow,e.infowindow.open(n.map,o),n.openWindow=e.infowindow},n.getMarker=function(e){var o={placeId:e.place_id},t=new google.maps.Marker({map:n.map,animation:google.maps.Animation.DROP,position:e.location});return google.maps.event.addListener(t,"click",function(){null!==n.openWindow&&n.openWindow.close(),null!==t.getAnimation()?t.setAnimation(null):t.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){t.setAnimation(null)},750),null===e.infowindow?n.getPhone(o,e,t):n.createWindow(e,t)}),t},n.yelpCallback=function(e,o,t){var a="<div><img src = "+e.businesses[0].image_url+" style ='float: right'><h3>"+o.name+"</h3>";a+="<img src = "+e.businesses[0].rating_img_url+"><br>",a+="<span>"+e.businesses[0].location.display_address+"</span><br>",a+="<p>"+e.businesses[0].snippet_text+"</p></div>",o.content=a,n.createWindow(o,t)},n.getYelpReviews=function(o,t){var a="https://api.yelp.com/v2/phone_search",i={oauth_consumer_key:"8adqtZAFILD_FbvKCKDx8A",oauth_token:"9B-tUp8F8gtSmCVRM4vMR0xdYn2FK_sB",oauth_nonce:e(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",phone:o.phone.toString().replace(/\D/g,"")},l=oauthSignature.generate("GET",a,i,"N8AHVg1nWklbXeOi-llodT7Vgco","J_xzioZbL5guY0d0l8uv56bCflM");i.oauth_signature=l;var r={url:a,data:i,cache:!0,dataType:"jsonp",success:function(e){n.yelpCallback(e,o,t)}};$.ajax(r).fail(function(){alert("Error getting Yelp data")})},n.changeMarkers=function(){null!==n.openWindow&&n.openWindow.close();for(var e=0;e<n.filteredLocations().length;e++)n.filteredLocations()[e].marker.setMap(null);n.filteredLocations.removeAll();for(var o=0;o<n.locations().length;o++)n.locations()[o].name.toLowerCase().indexOf(n.query().toLowerCase())>=0&&n.filteredLocations.push(n.locations()[o]);for(var e=0;e<n.filteredLocations().length;e++)null===n.filteredLocations()[e].marker.map&&n.filteredLocations()[e].marker.setMap(n.map)},n.centerMap=function(e){n.map.setCenter(e.location),google.maps.event.trigger(e.marker,"click")},google.maps.event.addDomListener(window,"resize",function(){n.map.setCenter(n.latlong)}),n.initMap()},Location=function(e){this.location=e.geometry.location,this.place_id=e.place_id,this.marker=null,this.name=e.name,this.vicinity=e.vicinity,this.types=e.types,this.phone=null,this.infowindow=null,this.content=null};
